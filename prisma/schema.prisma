//prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}


datasource db {
  provider = "postgresql"
}


// ============================================
// DEALERSHIPS, BRANCHES, INVENTORY & LOANS
// ============================================

model Dealership {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  website     String?

  branches Branch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Branch {
  id      String  @id @default(cuid())
  name    String
  address String
  phone   String?
  email   String?

  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  dealershipId String

  inventory BranchInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BranchInventory {
  id String @id @default(cuid())

  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  branchId String

  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId String

  stock Int     @default(0)
  price Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId])
  @@index([vehicleId])
}

model LoanRate {
  id            String  @id @default(cuid())
  bankName      String
  annualRate    Decimal @db.Decimal(5, 2)
  minTermMonths Int
  maxTermMonths Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// VEHICLE MANAGEMENT
// ============================================

model Vehicle {
  id      String  @id @default(cuid())
  slug    String  @unique
  brand   String
  model   String
  year    Int
  variant String?

  // Pricing
  cashPrice      Decimal @db.Decimal(12, 2)
  downPayment    Decimal @db.Decimal(12, 2)
  monthlyPayment Decimal @db.Decimal(10, 2)
  leaseTerm      Int // months

  // Specifications
  transmission    String
  fuelType        String
  engineSize      String?
  horsepower      Int?
  seatingCapacity Int
  cargoSpace      String?

  // Features & Details
  features       Json // Array of feature strings
  specifications Json // Detailed specs object
  description    String? @db.Text

  // Media
  images       VehicleImage[]
  videos       String[]
  model3dUrl   String?
  thumbnailUrl String

  // Status & Availability
  status       VehicleStatus @default(AVAILABLE)
  availability String // "Same Day Release", "1 Day Release", etc.
  featured     Boolean       @default(false)
  stockCount   Int           @default(0)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Relations
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String

  inquiries      Inquiry[]
  testDrives     TestDrive[]
  savedBy        SavedVehicle[]
  configurations Configuration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branchInventory BranchInventory[]

  @@index([brand, model, year])
  @@index([status, featured])
  @@index([categoryId])
}

model VehicleImage {
  id        String  @id @default(cuid())
  url       String
  alt       String
  type      String // "exterior", "interior", "features", "cargo"
  order     Int     @default(0)
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId String

  @@index([vehicleId, order])
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  icon        String?
  order       Int       @default(0)
  vehicles    Vehicle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String  @id @default(cuid())
  clerkId   String  @unique
  email     String  @unique
  firstName String
  lastName  String
  phone     String?
  avatar    String?

  // Preferences
  preferences Json?

  // Saved items
  savedVehicles  SavedVehicle[]
  configurations Configuration[]

  // Interactions
  inquiries  Inquiry[]
  testDrives TestDrive[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkId])
  @@index([email])
}

model SavedVehicle {
  id        String  @id @default(cuid())
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId String
  notes     String?

  createdAt DateTime @default(now())

  @@unique([userId, vehicleId])
  @@index([userId])
}

// ============================================
// CONFIGURATOR
// ============================================

model Configuration {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])
  vehicleId String

  // Configuration Details
  color       String
  colorHex    String
  wheels      String?
  interior    String?
  packages    Json // Array of selected packages
  accessories Json // Array of selected accessories

  // Pricing
  totalPrice Decimal @db.Decimal(12, 2)

  // Status
  shared     Boolean @default(false)
  shareToken String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([vehicleId])
}

// ============================================
// TEST DRIVE BOOKING
// ============================================

model TestDrive {
  id        String  @id @default(cuid())
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])
  vehicleId String

  // Booking Details
  preferredDate DateTime
  preferredTime String
  location      String // Dealership location

  // Contact (redundant for easy access)
  firstName String
  lastName  String
  email     String
  phone     String

  // Additional
  status     BookingStatus @default(PENDING)
  notes      String?       @db.Text
  adminNotes String?       @db.Text

  // Confirmation
  confirmedAt DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([vehicleId])
  @@index([status, preferredDate])
}

// ============================================
// INQUIRIES & LEADS
// ============================================

model Inquiry {
  id String @id @default(cuid())

  // User (optional - can be anonymous)
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  // Vehicle (optional - general inquiry)
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])
  vehicleId String?

  // Inquiry Type
  type InquiryType

  // Contact Info
  firstName String
  lastName  String
  email     String
  phone     String

  // Message
  subject String?
  message String  @db.Text

  // Status & Assignment
  status     InquiryStatus @default(NEW)
  assignedTo String? // Admin user ID

  // Response
  response    String?   @db.Text
  respondedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([vehicleId])
}

// ============================================
// FINANCING APPLICATIONS
// ============================================

model FinancingApplication {
  id String @id @default(cuid())

  // Personal Info
  firstName   String
  middleName  String?
  lastName    String
  email       String
  phone       String
  birthDate   DateTime
  civilStatus String
  address     String

  // Employment
  employmentStatus String // "Employed", "Self-Employed", "Business Owner"
  monthlyIncome    Decimal @db.Decimal(12, 2)
  employer         String?
  yearsEmployed    Int?

  // Desired Vehicle
  vehicleId        String
  vehicleName      String // Cached for reference
  downPayment      Decimal @db.Decimal(12, 2)
  loanTerm         Int // months
  estimatedMonthly Decimal @db.Decimal(10, 2)

  // Documents (stored as URLs in S3/CloudFlare)
  validIds       Json // Array of document URLs
  proofOfIncome  Json // Array of document URLs
  proofOfBilling Json // Array of document URLs

  // Status & Processing
  status         ApplicationStatus @default(PENDING)
  approvedAmount Decimal?          @db.Decimal(12, 2)
  approvedTerm   Int?

  // Notes
  applicantNotes String? @db.Text
  adminNotes     String? @db.Text

  // Timestamps
  submittedAt DateTime  @default(now())
  reviewedAt  DateTime?
  approvedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, submittedAt])
  @@index([email])
}

// ============================================
// TRADE-IN (SELL YOUR CAR)
// ============================================

model TradeIn {
  id String @id @default(cuid())

  // Contact
  firstName String
  lastName  String
  email     String
  phone     String

  // Vehicle Info
  brand        String
  model        String
  year         Int
  variant      String?
  mileage      Int
  transmission String
  fuelType     String
  color        String?

  // Condition
  condition      String // "Excellent", "Good", "Fair", "Poor"
  hasAccidents   Boolean @default(false)
  serviceHistory Boolean @default(false)

  // Media
  images      String[] // Array of image URLs
  description String?  @db.Text

  // Pricing
  expectedPrice Decimal? @db.Decimal(12, 2)
  offeredPrice  Decimal? @db.Decimal(12, 2)

  // Status
  status TradeInStatus @default(PENDING)

  // Notes
  applicantNotes  String? @db.Text
  evaluationNotes String? @db.Text

  // Timestamps
  evaluatedAt DateTime?
  offerMadeAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([email])
}

// ============================================
// PROMOTIONS & OFFERS
// ============================================

model Promotion {
  id          String @id @default(cuid())
  title       String
  slug        String @unique
  description String @db.Text

  // Media
  bannerImage    String
  thumbnailImage String?

  // Discount
  discountType  String // "PERCENTAGE", "FIXED_AMOUNT"
  discountValue Decimal @db.Decimal(10, 2)

  // Applicability
  vehicleIds String[] // Empty array = applies to all

  // Validity
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)

  // Terms
  terms String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, startDate, endDate])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id     String @id @default(cuid())
  userId String

  type    String // "TEST_DRIVE", "INQUIRY_RESPONSE", "PROMOTION", etc.
  title   String
  message String @db.Text

  link String?
  icon String?

  read Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId, read, createdAt])
}

// ============================================
// ENUMS
// ============================================

enum VehicleStatus {
  AVAILABLE
  RESERVED
  SOLD
  COMING_SOON
  OUT_OF_STOCK
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum InquiryType {
  GENERAL
  VEHICLE_INFO
  FINANCING
  TEST_DRIVE
  TRADE_IN
  AFTER_SALES
}

enum InquiryStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

enum TradeInStatus {
  PENDING
  EVALUATING
  OFFER_MADE
  ACCEPTED
  REJECTED
  COMPLETED
}
